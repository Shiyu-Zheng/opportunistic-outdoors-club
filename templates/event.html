<!DOCTYPE html>
<html lang="{{lang}}" class="">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{trip.title}} - {{site.title}}</title>
  <link rel="stylesheet" href="/src/styles.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
  {{> theme-init}}
  <script type="module" src="/src/main.js"></script>
</head>
<body class="min-h-screen bg-white dark:bg-zinc-900 text-zinc-900 dark:text-zinc-100 font-sans">
  {{> header}}

  <main class="max-w-6xl mx-auto px-4 py-12">
    <!-- Back link -->
    <a href="{{nav.homeLink}}" class="inline-flex items-center gap-2 text-sm text-zinc-500 hover:text-zinc-700 dark:text-zinc-400 dark:hover:text-zinc-200 mb-8">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 19l-7-7 7-7"></path>
      </svg>
      {{events.backLink}}
    </a>

    <!-- Gallery -->
    <div id="gallery" class="mb-10 [&_img]:cursor-pointer [&_img]:transition-opacity [&_img]:hover:opacity-90 [&_img]:[image-rendering:high-quality]" data-images='{{trip.images}}'></div>

    <!-- Event Header -->
    <div class="mb-10">
      <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
        <div>
          <h1 class="text-3xl md:text-4xl font-bold mb-3">{{trip.title}}</h1>
          <div class="flex flex-wrap items-center gap-3 text-zinc-600 dark:text-zinc-400">
            <span class="flex items-center gap-2" data-date="{{trip.date}}">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <span class="event-date"></span>
            </span>
            <span class="text-zinc-300 dark:text-zinc-600">|</span>
            <span>{{trip.times}}</span>
            <span class="text-zinc-300 dark:text-zinc-600">|</span>
            <span>{{trip.duration}}</span>
          </div>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold">{{trip.fee}}</div>
          <div class="flex items-center justify-end gap-1 text-sm">
            <span class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded-lg font-medium">{{trip.spotsFilled}}/{{trip.spotsTotal}}</span>
            <span class="text-zinc-500 dark:text-zinc-400">{{events.spotsLeft}}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Grid -->
    <div class="grid lg:grid-cols-3 gap-10">
      <!-- Main Content -->
      <div class="lg:col-span-2 space-y-10">
        <!-- Description -->
        <section>
          <h2 class="text-xl font-semibold mb-4">{{events.aboutTitle}}</h2>
          <p class="text-zinc-600 dark:text-zinc-400 leading-relaxed">{{trip.description}}</p>
        </section>

        <!-- Map -->
        <section>
          <div id="map" class="h-[400px] rounded-2xl bg-zinc-200 dark:bg-zinc-700"></div>
          <script id="map-data" type="application/json">{"gpxFile":"{{trip.gpxFile}}"}</script>
        </section>

        <!-- Itinerary Timeline -->
        <section id="itinerary-section" class="hidden">
          <h2 class="text-xl font-semibold mb-4">{{events.itineraryTitle}}</h2>
          <div id="itinerary-list" class="relative"></div>
          <script id="itinerary-data" type="application/json">{{trip.itinerary}}</script>
        </section>

        <!-- What to Wear -->
        <section id="wear-section" class="hidden">
          <h2 class="text-xl font-semibold mb-4">{{events.wearTitle}}</h2>
          <ul id="wear-list" class="space-y-3 text-zinc-600 dark:text-zinc-400"></ul>
          <script id="wear-data" type="application/json">{{trip.wear}}</script>
        </section>

        <!-- What to Bring -->
        <section>
          <h2 class="text-xl font-semibold mb-4">{{events.bringTitle}}</h2>
          <ul class="space-y-3 text-zinc-600 dark:text-zinc-400">
            {{#each trip.bring}}
            <li class="flex items-start gap-3">
              <svg class="w-5 h-5 text-green-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"></path>
              </svg>
              {{this}}
            </li>
            {{/each}}
          </ul>
        </section>

        <!-- Trip FAQ -->
        <section id="trip-faq-section" class="hidden">
          <h2 class="text-xl font-semibold mb-4">{{events.tripFaqTitle}}</h2>
          <div id="trip-faq-list" class="space-y-3"></div>
          <script id="trip-faq-data" type="application/json">{{trip.faq}}</script>
        </section>

        <!-- Learn More Links -->
        <section id="links-section" class="hidden">
          <h2 class="text-xl font-semibold mb-4">{{events.usefulLinksTitle}}</h2>
          <ul id="links-list" class="space-y-2"></ul>
          <script id="links-data" type="application/json">{{trip.links}}</script>
        </section>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Quick Info Card -->
        <div class="bg-zinc-100 dark:bg-zinc-800 rounded-2xl p-6">
          <h3 class="font-semibold mb-4">{{events.detailsTitle}}</h3>
          <dl class="space-y-4 text-sm">
            <div>
              <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400 mb-1">{{events.labels.meeting}}</dt>
              <dd class="text-zinc-700 dark:text-zinc-300">{{trip.meeting}}</dd>
            </div>
            <div>
              <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400 mb-1">{{events.labels.transport}}</dt>
              <dd class="text-zinc-700 dark:text-zinc-300">{{trip.transport}}</dd>
            </div>
            <div>
              <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400 mb-1">{{events.labels.route}}</dt>
              <dd class="text-zinc-700 dark:text-zinc-300">{{trip.routeDescription}}</dd>
            </div>
            <div>
              <dt class="text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400 mb-1">{{events.labels.difficulty}}</dt>
              <dd class="text-zinc-700 dark:text-zinc-300">{{trip.difficulty}}</dd>
            </div>
          </dl>
        </div>

        <!-- CTA Card -->
        <div class="bg-blue-50 dark:bg-blue-900/20 rounded-2xl p-6 text-center">
          <p class="text-sm text-zinc-600 dark:text-zinc-400 mb-4">{{events.ctaText}}</p>
          <a href="#" class="block w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-medium transition-colors">
            {{events.bookButton}}
          </a>
        </div>
      </div>
    </div>
  </main>

  {{> footer}}

  <!-- Image Modal -->
  <div id="image-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 backdrop-blur-sm">
    <button id="modal-close" class="absolute top-4 right-4 text-white hover:text-zinc-300 transition-colors">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
    <img id="modal-image" src="" alt="" class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg">
  </div>

  <script>
    (function() {
    document.addEventListener('DOMContentLoaded', function() {
      const lang = document.documentElement.lang || 'en';

      // Format date
      const dateContainer = document.querySelector('[data-date]');
      if (dateContainer) {
        const dateStr = dateContainer.dataset.date;
        const eventDate = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        const locale = lang === 'zh' ? 'zh-CN' : 'en-GB';
        const dateSpan = dateContainer.querySelector('.event-date');
        if (dateSpan) {
          dateSpan.textContent = eventDate.toLocaleDateString(locale, options);
        }
      }

      // Render wear list
      const wearSection = document.getElementById('wear-section');
      const wearList = document.getElementById('wear-list');
      const wearDataEl = document.getElementById('wear-data');
      if (wearSection && wearList && wearDataEl) {
        try {
          const wear = JSON.parse(wearDataEl.textContent);
          if (wear && wear.length > 0) {
            wearSection.classList.remove('hidden');
            wearList.innerHTML = wear.map(item => `
              <li class="flex items-start gap-3">
                <svg class="w-5 h-5 text-blue-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 13l4 4L19 7"></path>
                </svg>
                ${item}
              </li>
            `).join('');
          }
        } catch (e) {
          console.error('Failed to parse wear:', e);
        }
      }

      // Render itinerary timeline
      const itinerarySection = document.getElementById('itinerary-section');
      const itineraryList = document.getElementById('itinerary-list');
      const itineraryDataEl = document.getElementById('itinerary-data');
      if (itinerarySection && itineraryList && itineraryDataEl) {
        try {
          const itinerary = JSON.parse(itineraryDataEl.textContent);
          if (itinerary && itinerary.length > 0) {
            itinerarySection.classList.remove('hidden');
            itineraryList.innerHTML = itinerary.map((item, index) => {
              const isFirst = index === 0;
              const isLast = index === itinerary.length - 1;
              const dotColor = isFirst ? 'bg-green-500' : (isLast ? 'bg-blue-500' : 'bg-zinc-400 dark:bg-zinc-500');
              const lineClass = isLast ? 'hidden' : '';
              return `
                <div class="flex gap-4 relative">
                  <div class="flex flex-col items-center">
                    <div class="w-3 h-3 rounded-full ${dotColor} flex-shrink-0 mt-1.5"></div>
                    <div class="w-0.5 flex-1 bg-zinc-200 dark:bg-zinc-700 ${lineClass}"></div>
                  </div>
                  <div class="pb-2 flex gap-3 ${isLast ? 'pb-0' : ''}">
                    <span class="text-sm font-medium text-zinc-900 dark:text-zinc-100 flex-shrink-0 w-14">${item.time}</span>
                    <span class="text-sm text-zinc-600 dark:text-zinc-400">${item.description}</span>
                  </div>
                </div>
              `;
            }).join('');
          }
        } catch (e) {
          console.error('Failed to parse itinerary:', e);
        }
      }

      // Render trip FAQ
      const faqSection = document.getElementById('trip-faq-section');
      const faqList = document.getElementById('trip-faq-list');
      const faqDataEl = document.getElementById('trip-faq-data');
      if (faqSection && faqList && faqDataEl) {
        try {
          const faq = JSON.parse(faqDataEl.textContent);
          if (faq && faq.length > 0) {
            faqSection.classList.remove('hidden');
            faqList.innerHTML = faq.map((item, index) => `
              <div class="border border-zinc-200 dark:border-zinc-700 rounded-xl overflow-hidden">
                <button onclick="toggleTripFaq(this)" class="w-full flex items-center justify-between p-4 text-left hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors">
                  <span class="font-medium text-sm">${item.question}</span>
                  <svg class="trip-faq-icon w-5 h-5 text-zinc-400 flex-shrink-0 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v12m6-6H6"></path>
                  </svg>
                </button>
                <div class="trip-faq-answer hidden px-4 pb-4 pt-4 text-sm text-zinc-600 dark:text-zinc-400">
                  ${item.answer}
                </div>
              </div>
            `).join('');
          }
        } catch (e) {
          console.error('Failed to parse FAQ:', e);
        }
      }

      // Render map
      const mapDataEl = document.getElementById('map-data');
      if (mapDataEl) {
        try {
          const mapData = JSON.parse(mapDataEl.textContent);
          const { gpxFile, startLat, startLng, endLat, endLng, startLabel, endLabel } = mapData;

          const map = L.map('map');

          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
          }).addTo(map);

          if (gpxFile) {
            new L.GPX(gpxFile, {
              async: true,
              marker_options: {
                startIconUrl: null,
                endIconUrl: null,
                shadowUrl: null
              },
              polyline_options: {
                color: '#3b82f6',
                weight: 4,
                opacity: 0.8
              }
            }).on('loaded', function(e) {
              map.fitBounds(e.target.getBounds(), {padding: [30, 30]});
            }).addTo(map);
          } else {
            const centerLat = (startLat + endLat) / 2;
            const centerLng = (startLng + endLng) / 2;
            map.setView([centerLat, centerLng], 12);

            const startIcon = L.divIcon({
              className: 'custom-marker',
              html: '<div style="background-color: #22c55e; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            });

            const endIcon = L.divIcon({
              className: 'custom-marker',
              html: '<div style="background-color: #3b82f6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            });

            L.marker([startLat, startLng], {icon: startIcon}).addTo(map).bindPopup(startLabel);
            L.marker([endLat, endLng], {icon: endIcon}).addTo(map).bindPopup(endLabel);

            const bounds = L.latLngBounds([[startLat, startLng], [endLat, endLng]]);
            map.fitBounds(bounds, {padding: [50, 50]});
          }
        } catch (e) {
          console.error('Failed to parse map data:', e);
        }
      }

      // Render image gallery
      const galleryEl = document.getElementById('gallery');
      const imagesData = galleryEl.dataset.images;
      try {
        const images = JSON.parse(imagesData);
        if (images && images.length > 0) {
          const count = images.length;
          let heroHtml = '';
          let extraHtml = '';

          if (count === 1) {
            heroHtml = `<div class="h-[300px] md:h-[400px]">
              <img src="${images[0]}" alt="" class="w-full h-full object-cover rounded-2xl">
            </div>`;
          } else if (count === 2) {
            heroHtml = `<div class="grid grid-cols-2 gap-3 h-[300px] md:h-[400px]">
              <div class="overflow-hidden rounded-2xl">
                <img src="${images[0]}" alt="" class="w-full h-full object-cover">
              </div>
              <div class="overflow-hidden rounded-2xl">
                <img src="${images[1]}" alt="" class="w-full h-full object-cover">
              </div>
            </div>`;
          } else if (count === 3) {
            heroHtml = `<div class="grid grid-cols-3 gap-3 h-[300px] md:h-[400px]">
              <div class="col-span-2">
                <img src="${images[0]}" alt="" class="w-full h-full object-cover rounded-2xl">
              </div>
              <div class="flex flex-col gap-3">
                <img src="${images[1]}" alt="" class="w-full flex-1 object-cover rounded-xl">
                <img src="${images[2]}" alt="" class="w-full flex-1 object-cover rounded-xl">
              </div>
            </div>`;
          } else if (count === 4) {
            heroHtml = `<div class="grid grid-cols-4 grid-rows-2 gap-3 h-[300px] md:h-[400px]">
              <div class="col-span-2 row-span-2">
                <img src="${images[0]}" alt="" class="w-full h-full object-cover rounded-2xl">
              </div>
              <img src="${images[1]}" alt="" class="w-full h-full object-cover rounded-xl">
              <img src="${images[2]}" alt="" class="w-full h-full object-cover rounded-xl">
              <img src="${images[3]}" alt="" class="w-full h-full object-cover rounded-xl col-span-2">
            </div>`;
          } else {
            // 5+ images: show first 5 in hero grid
            heroHtml = `<div class="grid grid-cols-4 grid-rows-2 gap-3 h-[300px] md:h-[400px]">
              <div class="col-span-2 row-span-2">
                <img src="${images[0]}" alt="" class="w-full h-full object-cover rounded-2xl">
              </div>
              <img src="${images[1]}" alt="" class="w-full h-full object-cover rounded-xl">
              <img src="${images[2]}" alt="" class="w-full h-full object-cover rounded-xl">
              <img src="${images[3]}" alt="" class="w-full h-full object-cover rounded-xl">
              <img src="${images[4]}" alt="" class="w-full h-full object-cover rounded-xl">
            </div>`;

            // Show remaining images in a grid below
            if (count > 5) {
              const extraImages = images.slice(5);
              extraHtml = `<div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-3 mt-3">
                ${extraImages.map(src => `<img src="${src}" alt="" class="w-full aspect-square object-cover rounded-xl">`).join('')}
              </div>`;
            }
          }
          galleryEl.innerHTML = heroHtml + extraHtml;
        }
      } catch (e) {
        console.error('Failed to parse images:', e);
      }

      // Render links
      const linksSection = document.getElementById('links-section');
      const linksList = document.getElementById('links-list');
      const linksDataEl = document.getElementById('links-data');
      if (!linksSection || !linksList || !linksDataEl) return;
      try {
        const links = JSON.parse(linksDataEl.textContent);
        if (links && links.length > 0) {
          linksSection.classList.remove('hidden');
          linksList.innerHTML = links.map(link =>
            `<li><a href="${link.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-2">
              <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
              </svg>
              ${link.label}
            </a></li>`
          ).join('');
        }
      } catch (e) {
        console.error('Failed to parse links:', e);
      }
    });

    // Toggle trip FAQ accordion
    window.toggleTripFaq = function(button) {
      const item = button.parentElement;
      const answer = item.querySelector('.trip-faq-answer');
      const icon = item.querySelector('.trip-faq-icon');
      const isOpen = !answer.classList.contains('hidden');

      if (isOpen) {
        answer.classList.add('hidden');
        icon.style.transform = 'rotate(0deg)';
      } else {
        answer.classList.remove('hidden');
        icon.style.transform = 'rotate(45deg)';
      }
    };

    // Image modal
    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('modal-image');
    const modalClose = document.getElementById('modal-close');
    let galleryImages = [];
    let currentIndex = 0;

    function openModal(src) {
      galleryImages = Array.from(document.querySelectorAll('#gallery img')).map(img => img.src);
      currentIndex = galleryImages.indexOf(src);
      modalImg.src = src;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      modalImg.src = '';
      document.body.style.overflow = '';
    }

    function showImage(index) {
      if (index < 0) index = galleryImages.length - 1;
      if (index >= galleryImages.length) index = 0;
      currentIndex = index;
      modalImg.src = galleryImages[currentIndex];
    }

    // Click on gallery images
    document.getElementById('gallery').addEventListener('click', function(e) {
      if (e.target.tagName === 'IMG') {
        openModal(e.target.src);
      }
    });

    // Close on X button
    modalClose.addEventListener('click', closeModal);

    // Close on backdrop click
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeModal();
      }
    });

    // Keyboard navigation
    document.addEventListener('keydown', function(e) {
      if (modal.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeModal();
      if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
      if (e.key === 'ArrowRight') showImage(currentIndex + 1);
    });
    })();
  </script>
</body>
</html>
